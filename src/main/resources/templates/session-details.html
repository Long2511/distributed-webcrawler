<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Distributed Web Crawler - Session Details</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"/>
    <style>
        .stats-card {
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .url-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .progress-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .status-badge {
            font-size: 1rem;
        }
        .detail-card {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Distributed Web Crawler</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-speedometer2"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/sessions"><i class="bi bi-list-check"></i> Sessions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor"><i class="bi bi-graph-up"></i> Monitor</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alerts for success/error messages -->
        <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${success != null}">
            <i class="bi bi-check-circle-fill"></i> <span th:text="${success}">Success message</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${error != null}">
            <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}">Error message</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/sessions">Sessions</a></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${session.name}">Session Name</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-card-list"></i> Session Details</h1>
            <div class="action-buttons">
                <a href="/sessions" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> Back to Sessions
                </a>
                <span th:if="${session.status == 'RUNNING'}">
                    <button class="btn btn-warning me-2" id="pauseSessionBtn">
                        <i class="bi bi-pause-fill"></i> Pause Session
                    </button>
                    <button class="btn btn-danger" id="stopSessionBtn">
                        <i class="bi bi-stop-fill"></i> Stop Session
                    </button>
                </span>
                <span th:if="${session.status == 'PAUSED'}">
                    <button class="btn btn-success" id="resumeSessionBtn">
                        <i class="bi bi-play-fill"></i> Resume Session
                    </button>
                </span>
                <button class="btn btn-danger" id="deleteSessionBtn" th:if="${session.status != 'RUNNING'}">
                    <i class="bi bi-trash"></i> Delete Session
                </button>
            </div>
        </div>

        <!-- Session Progress Card -->
        <div class="card detail-card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-activity"></i> Crawling Progress</span>
                    <span th:if="${session.status}" class="badge status-badge" th:classappend="${
                        session.status == 'RUNNING' ? 'bg-success' :
                        session.status == 'COMPLETED' ? 'bg-primary' :
                        session.status == 'PAUSED' ? 'bg-warning' :
                        session.status == 'FAILED' ? 'bg-danger' :
                        'bg-secondary'
                    }" th:text="${session.status}">STATUS</span>
                </div>
            </div>
            <div class="card-body">
                <div class="progress-label">Overall Progress:</div>
                <div class="progress mb-4" style="height: 25px;">
                    <div id="progressBar" class="progress-bar bg-success progress-bar-striped" role="progressbar"
                         th:style="'width: ' + ${stats != null && stats['progress'] != null ? stats['progress'] : 0} + '%'"
                         th:aria-valuenow="${stats != null && stats['progress'] != null ? stats['progress'] : 0}"
                         aria-valuemin="0" aria-valuemax="100">
                        <span th:text="${stats != null && stats['progress'] != null ? stats['progress'] + '%' : '0%'}">0%</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light stats-card">
                            <div class="card-body text-center">
                                <h2 th:text="${stats != null && stats['discoveredUrls'] != null ? stats['discoveredUrls'] : 0}">0</h2>
                                <p class="text-muted mb-0">URLs Discovered</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light stats-card">
                            <div class="card-body text-center">
                                <h2 th:text="${stats != null && stats['crawledPages'] != null ? stats['crawledPages'] : 0}">0</h2>
                                <p class="text-muted mb-0">Pages Crawled</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light stats-card">
                            <div class="card-body text-center">
                                <h2 th:text="${stats != null && stats['failedUrls'] != null ? stats['failedUrls'] : 0}">0</h2>
                                <p class="text-muted mb-0">Failed URLs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light stats-card">
                            <div class="card-body text-center">
                                <h2 th:text="${session.createdAt != null && session.completedAt != null ?
                                    #temporals.format(java.time.Duration.between(session.createdAt,
                                    (session.completedAt != null ? session.completedAt : java.time.LocalDateTime.now())).toMinutes(), '0') + ' min' : 'N/A'}">0 min</h2>
                                <p class="text-muted mb-0">Duration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <!-- Session Details Card -->
                <div class="card detail-card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-info-circle"></i> Session Information
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <tr>
                                <td><strong>ID:</strong></td>
                                <td th:text="${session.id}">session-id</td>
                            </tr>
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td th:text="${session.name}">Session Name</td>
                            </tr>
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td th:text="${session.createdAt != null ? #temporals.format(session.createdAt, 'dd-MM-yyyy HH:mm:ss') : 'N/A'}">01-01-2025 12:00:00</td>
                            </tr>
                            <tr>
                                <td><strong>Last Updated:</strong></td>
                                <td th:text="${session.updatedAt != null ? #temporals.format(session.updatedAt, 'dd-MM-yyyy HH:mm:ss') : 'N/A'}">01-01-2025 12:00:00</td>
                            </tr>
                            <tr>
                                <td><strong>Completed:</strong></td>
                                <td th:text="${session.completedAt != null ? #temporals.format(session.completedAt, 'dd-MM-yyyy HH:mm:ss') : 'In Progress'}">N/A</td>
                            </tr>
                            <tr>
                                <td><strong>Max Depth:</strong></td>
                                <td th:text="${session.maxDepth}">3</td>
                            </tr>
                            <tr>
                                <td><strong>Respect Robots.txt:</strong></td>
                                <td>
                                    <span th:if="${session.respectRobotsTxt}" class="text-success">
                                        <i class="bi bi-check-circle-fill"></i> Yes
                                    </span>
                                    <span th:unless="${session.respectRobotsTxt}" class="text-danger">
                                        <i class="bi bi-x-circle-fill"></i> No
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Seed URLs Card -->
                <div class="card detail-card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-link-45deg"></i> Seed URLs
                    </div>
                    <div class="card-body">
                        <div class="url-list">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>URL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="url, urlStat : ${session.seedUrls}">
                                        <td th:text="${urlStat.count}">1</td>
                                        <td>
                                            <a th:href="${url}" target="_blank" th:text="${url}">https://example.com</a>
                                        </td>
                                    </tr>
                                    <tr th:if="${session.seedUrls == null || session.seedUrls.isEmpty()}">
                                        <td colspan="2" class="text-center">No seed URLs available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crawled Pages Card -->
        <div class="card detail-card" id="crawledPagesCard">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-file-earmark-text"></i> Recent Crawled Pages</span>
                    <button class="btn btn-sm btn-light" id="refreshPagesBtn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Outgoing Links</th>
                                <th>Crawled At</th>
                            </tr>
                        </thead>
                        <tbody id="crawledPagesTable">
                            <tr>
                                <td colspan="5" class="text-center">Loading crawled pages...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <button id="loadMoreBtn" class="btn btn-outline-primary" style="display: none;">
                        Load More Pages
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteSessionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this crawl session? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-dark text-white text-center">
        <div class="container">
            <p>Distributed Web Crawler &copy; 2025 | Version 1.0</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Get session ID from model
        const sessionId = /*[[${session.id}]]*/ 'test-session-id';
        let currentPage = 0;
        let totalPages = 0;
        const pageSize = 10;

        document.addEventListener('DOMContentLoaded', function() {
            // Load crawled pages on page load
            loadCrawledPages();

            // Refresh button
            document.getElementById('refreshPagesBtn').addEventListener('click', function() {
                currentPage = 0;
                loadCrawledPages();
            });

            // Load more button
            document.getElementById('loadMoreBtn').addEventListener('click', function() {
                currentPage++;
                loadCrawledPages(true);
            });

            // Session control buttons
            if (document.getElementById('pauseSessionBtn')) {
                document.getElementById('pauseSessionBtn').addEventListener('click', function() {
                    pauseSession(sessionId);
                });
            }

            if (document.getElementById('resumeSessionBtn')) {
                document.getElementById('resumeSessionBtn').addEventListener('click', function() {
                    resumeSession(sessionId);
                });
            }

            if (document.getElementById('stopSessionBtn')) {
                document.getElementById('stopSessionBtn').addEventListener('click', function() {
                    stopSession(sessionId);
                });
            }

            if (document.getElementById('deleteSessionBtn')) {
                document.getElementById('deleteSessionBtn').addEventListener('click', function() {
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteSessionModal'));
                    deleteModal.show();
                });
            }

            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                deleteSession(sessionId);
            });
        });

        // Helper function to get CSRF token
        function getCsrfToken() {
            const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
            if (csrfTokenMeta) {
                return csrfTokenMeta.getAttribute('content');
            }
            return null;
        }

        function getCsrfHeader() {
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
            if (csrfHeaderMeta) {
                return csrfHeaderMeta.getAttribute('content');
            }
            return 'X-CSRF-TOKEN';
        }

        // Load crawled pages
        function loadCrawledPages(append = false) {
            fetch(`/api/sessions/${sessionId}/pages?page=${currentPage}&size=${pageSize}`)
                .then(response => response.json())
                .then(data => {
                    updateCrawledPagesTable(data.content, append);
                    totalPages = data.totalPages;

                    // Show/hide load more button
                    document.getElementById('loadMoreBtn').style.display =
                        currentPage < totalPages - 1 ? 'inline-block' : 'none';
                })
                .catch(error => {
                    console.error('Error loading crawled pages:', error);
                    document.getElementById('crawledPagesTable').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                Failed to load crawled pages. Please try again.
                            </td>
                        </tr>
                    `;
                });
        }

        // Update crawled pages table
        function updateCrawledPagesTable(pages, append) {
            const tableBody = document.getElementById('crawledPagesTable');

            if (!append) {
                tableBody.innerHTML = '';
            }

            if (pages.length === 0 && !append) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">No pages have been crawled yet.</td>
                    </tr>
                `;
                return;
            }

            pages.forEach(page => {
                const row = document.createElement('tr');

                // Format date
                let crawledDate = 'N/A';
                if (page.crawlTimestamp) {
                    try {
                        crawledDate = new Date(page.crawlTimestamp).toLocaleString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                }

                // Status class
                let statusClass = 'bg-secondary';
                if (page.statusCode) {
                    if (page.statusCode >= 200 && page.statusCode < 300) {
                        statusClass = 'bg-success';
                    } else if (page.statusCode >= 300 && page.statusCode < 400) {
                        statusClass = 'bg-info';
                    } else if (page.statusCode >= 400 && page.statusCode < 500) {
                        statusClass = 'bg-warning';
                    } else if (page.statusCode >= 500) {
                        statusClass = 'bg-danger';
                    }
                }

                row.innerHTML = `
                    <td>
                        <a href="${page.url}" target="_blank" class="small text-truncate d-inline-block" style="max-width: 200px;">
                            ${page.url || 'N/A'}
                        </a>
                    </td>
                    <td>
                        <span class="text-truncate d-inline-block" style="max-width: 200px;">
                            ${page.title || 'No Title'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${statusClass}">
                            ${page.statusCode || 'N/A'}
                        </span>
                    </td>
                    <td>
                        ${page.outgoingLinks ? page.outgoingLinks.length : 0}
                    </td>
                    <td>
                        ${crawledDate}
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Pause session
        function pauseSession(id) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers[getCsrfHeader()] = csrfToken;
            }

            fetch('/sessions/' + id + '/pause', {
                method: 'POST',
                headers: headers
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to pause session');
                }
            });
        }

        // Resume session
        function resumeSession(id) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers[getCsrfHeader()] = csrfToken;
            }

            fetch('/sessions/' + id + '/resume', {
                method: 'POST',
                headers: headers
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to resume session');
                }
            });
        }

        // Stop session
        function stopSession(id) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers[getCsrfHeader()] = csrfToken;
            }

            fetch('/sessions/' + id + '/stop', {
                method: 'POST',
                headers: headers
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to stop session');
                }
            });
        }

        // Delete session
        function deleteSession(id) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers[getCsrfHeader()] = csrfToken;
            }

            fetch('/sessions/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    ...headers
                },
                body: `id=${id}`
            }).then(response => {
                if (response.ok) {
                    window.location.href = '/sessions';
                } else {
                    alert('Failed to delete session');
                }
            });
        }
    </script>
</body>
</html>
