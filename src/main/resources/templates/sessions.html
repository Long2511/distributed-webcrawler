<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Distributed Web Crawler - Sessions</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"/>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Distributed Web Crawler</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-speedometer2"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/sessions"><i class="bi bi-list-check"></i> Sessions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor"><i class="bi bi-graph-up"></i> Monitor</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-list-check"></i> Crawl Sessions</h1>
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-outline-secondary me-2" id="toggleAutoRefresh">
                    <i class="bi bi-arrow-clockwise"></i> Auto-Refresh On
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSessionModal">
                    <i class="bi bi-plus-circle"></i> New Session
                </button>
            </div>
        </div>

        <div id="noSessionsAlert" class="alert alert-info" style="display: none;">
            <i class="bi bi-info-circle"></i> No crawl sessions found. Create a new session to start crawling.
        </div>

        <div id="sessionsTableCard" class="card mb-4">
            <div class="card-header bg-primary text-white">
                Active and Completed Sessions
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Seed URLs</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody">
                        <!-- Session rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-info-circle"></i> Session Statistics
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="totalSessions">0</h3>
                                <p class="mb-0">Total Sessions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="activeSessions">0</h3>
                                <p class="mb-0">Active Sessions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="completedSessions">0</h3>
                                <p class="mb-0">Completed Sessions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="avgSessionDuration">0 min</h3>
                                <p class="mb-0">Avg. Duration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Session Modal -->
    <div class="modal fade" id="newSessionModal" tabindex="-1" aria-labelledby="newSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/sessions}" method="POST">
                    <!-- CSRF token for Spring Security -->
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" th:if="${_csrf}" />
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="newSessionModalLabel">
                            <i class="bi bi-plus-circle"></i> New Crawl Session
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="sessionName" class="form-label">Session Name</label>
                            <input type="text" class="form-control" id="sessionName" name="name"
                                   placeholder="My Crawl Session" required>
                        </div>
                        <div class="mb-3">
                            <label for="seedUrls" class="form-label">Seed URLs</label>
                            <textarea class="form-control" id="seedUrls" name="seedUrls" rows="4"
                                      placeholder="https://example.com/&#10;https://another-site.com/" required></textarea>
                            <div class="form-text">Enter one URL per line</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxDepth" class="form-label">Max Depth</label>
                                    <input type="number" class="form-control" id="maxDepth"
                                           name="maxDepth" value="3" min="1" max="20">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="politenessDelay" class="form-label">Politeness Delay (ms)</label>
                                    <input type="number" class="form-control" id="politenessDelay"
                                           name="politenessDelay" value="500" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="respectRobotsTxt"
                                       name="respectRobotsTxt" checked>
                                <label class="form-check-label" for="respectRobotsTxt">
                                    Respect robots.txt
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Session</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this crawl session? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" th:action="@{/sessions/delete}" method="POST">
                        <input type="hidden" id="deleteSessionId" name="id">
                        <!-- CSRF token for Spring Security -->
                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" th:if="${_csrf}" />
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-dark text-white text-center">
        <div class="container">
            <p>Distributed Web Crawler &copy; 2025 | Version 1.0</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Initialize popovers
        document.addEventListener('DOMContentLoaded', function() {
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl, {
                    html: true
                });
            });

            // Initial fetch
            fetchSessions();
            fetchSessionStats();

            // Setup refresh intervals
            autoRefreshInterval = setInterval(function() {
                if (autoRefreshEnabled) {
                    fetchSessions();
                    fetchSessionStats();
                }
            }, refreshInterval);
        });

        // Helper function to get CSRF token if available
        function getCsrfToken() {
            const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
            if (csrfTokenMeta) {
                return csrfTokenMeta.getAttribute('content');
            }
            return null;
        }

        function getCsrfHeader() {
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
            if (csrfHeaderMeta) {
                return csrfHeaderMeta.getAttribute('content');
            }
            return 'X-CSRF-TOKEN';
        }

        // Session auto-refresh
        let autoRefreshEnabled = true;
        let refreshInterval = 5000; // 5 seconds
        let autoRefreshInterval;

        // Toggle auto-refresh
        document.getElementById('toggleAutoRefresh').addEventListener('click', function() {
            autoRefreshEnabled = !autoRefreshEnabled;
            this.innerHTML = autoRefreshEnabled
                ? '<i class="bi bi-arrow-clockwise"></i> Auto-Refresh On'
                : '<i class="bi bi-pause"></i> Auto-Refresh Off';
        });

        // Fetch sessions data
        function fetchSessions() {
            fetch('/api/sessions')
                .then(response => response.json())
                .then(sessions => {
                    updateSessionsTable(sessions);
                })
                .catch(error => {
                    console.error('Error fetching sessions:', error);
                });
        }

        // Fetch session statistics
        function fetchSessionStats() {
            fetch('/api/sessions/stats')
                .then(response => response.json())
                .then(stats => {
                    updateStatsUI(stats);
                })
                .catch(error => {
                    console.error('Error fetching session statistics:', error);
                });
        }

        // Update the sessions table UI
        function updateSessionsTable(sessions) {
            const tableBody = document.getElementById('sessionsTableBody');
            tableBody.innerHTML = '';

            if (sessions.length === 0) {
                document.getElementById('noSessionsAlert').style.display = 'block';
                document.getElementById('sessionsTableCard').style.display = 'none';
            } else {
                document.getElementById('noSessionsAlert').style.display = 'none';
                document.getElementById('sessionsTableCard').style.display = 'block';

                sessions.forEach(session => {
                    const row = document.createElement('tr');

                    // Determine status badge class
                    let statusClass;
                    switch (session.status) {
                        case 'RUNNING': statusClass = 'bg-success'; break;
                        case 'COMPLETED': statusClass = 'bg-primary'; break;
                        case 'PAUSED': statusClass = 'bg-warning'; break;
                        case 'FAILED': statusClass = 'bg-danger'; break;
                        case 'CANCELLED': statusClass = 'bg-secondary'; break;
                        case 'STOPPED': statusClass = 'bg-secondary'; break;
                        default: statusClass = 'bg-secondary';
                    }

                    // Format date
                    let createdDate = 'N/A';
                    if (session.createdAt) {
                        try {
                            createdDate = new Date(session.createdAt).toLocaleString('en-GB', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }).replace(',', '');
                        } catch (e) {
                            console.error('Error formatting date:', e);
                        }
                    }

                    // Build seed URLs for popover - handle possible undefined seedUrls
                    const seedUrls = session.seedUrls || [];
                    // Escape HTML in URLs to prevent XSS
                    const escapedSeedUrls = seedUrls.map(url =>
                        String(url).replace(/&/g, '&amp;')
                                  .replace(/</g, '&lt;')
                                  .replace(/>/g, '&gt;')
                                  .replace(/"/g, '&quot;')
                                  .replace(/'/g, '&#039;'));
                    const seedUrlsHtml = escapedSeedUrls.join('<br>');

                    // Handle progress safely
                    let progress = session.progress || 0;
                    // Make sure progress is a valid number between 0-100
                    progress = isNaN(progress) ? 0 : Math.max(0, Math.min(100, progress));

                    // Progress bar color based on progress value
                    let progressBarClass = 'bg-info';
                    if (progress === 100) {
                        progressBarClass = 'bg-success';
                    } else if (progress > 66) {
                        progressBarClass = 'bg-primary';
                    } else if (progress > 33) {
                        progressBarClass = 'bg-info';
                    } else {
                        progressBarClass = 'bg-warning';
                    }

                    row.innerHTML = `
                        <td>${session.id || 'N/A'}</td>
                        <td>${session.name || 'Unnamed Session'}</td>
                        <td><span class="badge ${statusClass}">${session.status || 'UNKNOWN'}</span></td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar ${progressBarClass}" role="progressbar"
                                     style="width: ${progress}%"
                                     aria-valuenow="${progress}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">${progress}%</div>
                            </div>
                        </td>
                        <td>
                            <span>${seedUrls.length}</span>
                            ${seedUrls.length > 0 ?
                                `<button class="btn btn-sm btn-outline-secondary seed-url-btn"
                                    data-bs-toggle="popover"
                                    data-bs-trigger="focus"
                                    title="Seed URLs"
                                    data-bs-content="${seedUrlsHtml}">
                                    <i class="bi bi-eye-fill"></i>
                                </button>` : ''}
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/sessions/${session.id}"
                                   class="btn btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                                ${session.status === 'RUNNING' ?
                                    `<button onclick="pauseSession('${session.id}')" class="btn btn-outline-warning">
                                        <i class="bi bi-pause-fill"></i>
                                    </button>` : ''
                                }
                                ${session.status === 'PAUSED' ?
                                    `<button onclick="resumeSession('${session.id}')" class="btn btn-outline-success">
                                        <i class="bi bi-play-fill"></i>
                                    </button>` : ''
                                }
                                <button onclick="deleteSession('${session.id}')" class="btn btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

                // Re-initialize popovers for the seed URL buttons
                var urlBtns = document.querySelectorAll('.seed-url-btn');
                urlBtns.forEach(btn => {
                    new bootstrap.Popover(btn, { html: true });
                });
            }
        }

        // Update the statistics UI
        function updateStatsUI(stats) {
            // Check if stats is undefined or null
            if (!stats) {
                stats = {
                    totalSessions: 0,
                    activeSessions: 0,
                    completedSessions: 0,
                    avgSessionDuration: 0
                };
            }

            // Set values with fallbacks
            document.getElementById('totalSessions').innerText = stats.totalSessions || 0;
            document.getElementById('activeSessions').innerText = stats.activeSessions || 0;
            document.getElementById('completedSessions').innerText = stats.completedSessions || 0;

            // Format the average duration nicely
            const avgDuration = stats.avgSessionDuration || 0;
            const formattedDuration = isNaN(avgDuration) ? '0 min' :
                                    (avgDuration < 1 ? '<1 min' : `${avgDuration} min`);
            document.getElementById('avgSessionDuration').innerText = formattedDuration;
        }

        // Pause a session
        function pauseSession(id) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers[getCsrfHeader()] = csrfToken;
            }

            fetch('/sessions/' + id + '/pause', {
                method: 'POST',
                headers: headers
            }).then(response => {
                if (response.ok) {
                    fetchSessions(); // Refresh data instead of reloading page
                } else {
                    alert('Failed to pause session');
                }
            });
        }

        // Resume a session
        function resumeSession(id) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers[getCsrfHeader()] = csrfToken;
            }

            fetch('/sessions/' + id + '/resume', {
                method: 'POST',
                headers: headers
            }).then(response => {
                if (response.ok) {
                    fetchSessions(); // Refresh data instead of reloading page
                } else {
                    alert('Failed to resume session');
                }
            });
        }

        // Delete confirmation
        function deleteSession(id) {
            document.getElementById('deleteSessionId').value = id;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
    </script>
</body>
</html>
